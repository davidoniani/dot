#!/usr/bin/env sh

# Get all contacts by parsing a maildir (experimental script)
# by David Oniani <onianidavid@gmail.com>
# License: GNU GPLv3

ABOOKDB="$HOME/.local/share/abook/abook"
MAILDIR="$HOME/.local/share/mail/[Gmail].Sent Mail/cur"
TMPFILE="$(mktemp)"

CSVFILE="$(grep -Rh "To:[[:space:]].*.<.*.@.*.\..*.>" "$MAILDIR" |
           grep -iv "reply" |
           sed "s/.*:[[:space:]]*//g; s/>.*//g; s/[[:space:]]</,/g" |
           sort -fu)"

printf "%s\n" "$CSVFILE" > "$TMPFILE"

rm -f "$ABOOKDB"

abook --datafile "$ABOOKDB" \
      --convert \
      --infile "$TMPFILE" --informat csv \
      --outfile "$HOME/.local/share/abook/abook" --outformat abook

rm -f "$TMPFILE" >/dev/null
