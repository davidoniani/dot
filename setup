#!/usr/bin/env sh

# Setup utility
# by David Oniani <onianidavid@gmail.com>
# License: MIT License

config() {
    cp -R .config "$HOME"
    cp -R .local "$HOME"
    cp .zshenv "$HOME"

    mkdir -p "$HOME/dl" "$HOME/doc" "$HOME/git" "$HOME/pic" "$HOME/wip"
    mkdir -p "${XDG_CACHE_HOME:-$HOME/.cache}/zsh"
}

nosudo() {
    sudo touch "/etc/sudoers.d/$USER"
    printf "%s ALL=(ALL:ALL) NOPASSWD: ALL\n" "$USER" | sudo tee "/etc/sudoers.d/$USER"

    sudo touch /etc/sudoers.d/disable_admin_file_in_home
    printf "Defaults !admin_flag\n" | sudo tee /etc/sudoers.d/disable_admin_file_in_home
}

program() {
    sed 1d programs.csv | while IFS=, read -r tag name description; do
        printf "Installing %s (%s)\n" "$name" "$description"
        case $tag in
            PACMAN) sudo pacman -S  --noconfirm "$name";;
            AUR) paru -S --noconfirm "$name";;
            *) printf "%s\n" "Wrong tag!" >&2 && exit 1;;
        esac
    done
}

vscode() {
    link="https://code.visualstudio.com/sha/download?build=stable&os=linux-x64"
    wget -q --show-progress -O vscode_stable_linux-x64.tar.gz "$link"
    tar -C "$HOME"/.local -xzvf vscode_stable_linux-x64.tar.gz
    rm -f vscode_stable_linux-x64.tar.gz
    rm -rf "$HOME"/.local/vscode
    mv "$HOME"/.local/VSCode-linux-x64 "$HOME"/.local/vscode
    cd "$HOME"/.local/vscode || exit
    mkdir data
}

help() {
    printf "usage: ./setup [option]\n\
    --config     Copy configuration files\n\
    --nosudo     Configure sudo behavior\n\
    --program    Install all necessary programs\n\
    --vscode     Install Visual Studio Code (portable mode)\n"
}

case $1 in
    "--config") config;;
    "--program") program;;
    "--nosudo") nosudo;;
    "--vscode") vscode;;
    *) help;;
esac
